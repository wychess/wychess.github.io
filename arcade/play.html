<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>wychess arcade</title>
  <link rel="shortcut icon" href="img/wychess_arcade_square.png" type="image/x-icon" />

  <link rel="stylesheet" href="css/FlexStyle.css">
  <script src="css/FlexWyCss.js"></script>

  <script src="js/flex/FlexWebAssembly.js"></script>
  <script src="js/flex/FlexEngine.js"></script>

  <script src="js/deps/HTML.js"></script>
  <script src="js/deps/SVG.js"></script>
  <script src="js/deps/JavaScript.js"></script>

  <script src="js/core/EmbedChannel.js"></script>
  <script src="js/core/FlexTouch.js"></script>
  <script src="js/core/FlexBoard.js"></script>
  <script src="js/core/FlexGen.js"></script>
  <script src="js/core/FlexGest.js"></script>
  <script src="js/core/FlexHelp.js"></script>

  <script src="js/app/arcade/FlexApp.js"></script>

  <script>
    let flexApp = null
    let flexGest = null

    const flex_host = 'http://localhost:8000'

    const ActivityJs = {
      setHistory: function(x, y, history) {
        window.localStorage.setItem(x + 'x' + y, history)
      }
    }

    function getIntFromUrl(def, ind) {
      try {
        return parseInt(unescape(location.search).split('?')[1].split('')[ind]) || def
      } catch(e) {
        return def
      }
    }

    function addExtraAction(label, action) {
      let elem = $$$(button({style: 'margin: 10px;'}), label)
      elem.addEventListener('click', action)
      elem.setAttribute('class', 'grow')
      document.getElementById('extra').appendChild(elem)
    }

    function resetBoard(X, Y, history) {
      let staleDom = document.getElementById("stale")
      let wrapDom = document.getElementById("wrap")
      let flexDom = document.getElementById("flex")
      flexDom.innerHTML = ''
      flexApp = new FlexApp(stale, wrapDom, flexDom, X, Y, history, {
        marginPercent: 15,
      })

      flexGest = new FlexGest(wrapDom, flexApp.flexBoard.chessLayer.layerDom, {

        tapAndHoldMarker: function() {
          if (flexApp.canTakeBack()) {
            flexApp.flexBoard.showLoader()
          }
        },

        tapAndHoldCancel: function() {
          flexApp.flexBoard.hideLoader()
        },

        tapAndHoldCommit: function() {
          flexApp.takeBack()
          flexApp.flexBoard.hideLoader()
        },

        slideAccept: function() {
          flexApp.markEnd()
        },

        slideReject: function() {
          const history = FlexEngineJs.getBoard(X, Y, "", "")
          window.localStorage.setItem(X + 'x' + Y, history)
          resetBoard(X, Y, history)
        },

        doubleTap: function() {
          if (flexApp.canResetFlag) {
            const history = FlexEngineJs.getBoard(X, Y, "", "")
            window.localStorage.setItem(X + 'x' + Y, history)
            resetBoard(X, Y, history)
          }
        }
      })
    }

    function doBootstrap(X, Y) {
      OnFlexEngineJsLoaded(function() {
        document.title = 'wychess arcade ' + X + 'x' + Y
        const history = window.localStorage.getItem(X + 'x' + Y) || FlexEngineJs.getBoard(X, Y, "", "")
        resetBoard(X, Y, history)
        addExtraAction('pick size', function() {
          document.location = flex_host + '/index.html'
        })
        addExtraAction('reset', function() {
          const history = FlexEngineJs.getBoard(X, Y, "", "")
          window.localStorage.setItem(X + 'x' + Y, history)
          resetBoard(X, Y, history)
        })
        addExtraAction('take back', function() {
          flexApp.takeBack()
        })
        addExtraAction('get android apk', function() {
          if (confirm("The App does not require any permissions.\n" +
                      "It works entirely offline.\n" +
                      "The original sha1sum of file: ce1502548c9710952018e62a4b0261b497a2223a.\n" +
                      "If you encounter any suspicious App behaviour please contact wychess@wychess.com.\n" +
                      "Please confirm that you understand the risk of installing software from malicious sources.")) {
            document.location = wychess_host + '/release/wychess-arcade-v1.11.apk'
          }
        })
      })
    }

    function bootstrap() {
      const X = Math.max(3, Math.min(8, getIntFromUrl(6, 2))) // 2: "X=_&Y=8"
      const Y = Math.max(3, Math.min(8, getIntFromUrl(6, 6))) // 6: "X=8&Y=_"
      doBootstrap(X, Y)
    }
  </script>
</head>

<body onload="bootstrap();">
  <div id="stale" style="position: absolute; width: 100%; height: 100%;"></div>
  <div id="wrap" style="position: absolute; width: 100%; height: 100%; z-index: 1;"></div>
  <div id="flex" style="position: absolute; width: 100%; height: 100%;"></div>
  <div id="extra" style="position: fixed; left: 0; bottom: 0; z-index: 2;"></div>
</body>
</html>
